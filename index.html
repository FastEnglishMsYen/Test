<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Sentence Puzzle</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1001/1001259.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
            transition: background 0.5s ease;
        }

        .screen {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            will-change: opacity, transform;
        }
        .screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .input-field {
            border: 2px solid #A78BFA;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .input-field:focus {
            outline: none;
            border-color: #026178;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
        }

        .btn {
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-primary {
            background-color: #026178;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #022E39;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .btn-primary:active:not(:disabled) {
            transform: translateY(0px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary:disabled {
            background-color: #A78BFA;
            opacity: 0.7;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-secondary {
            background-color: #3B82F6;
            color: white;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #2563EB;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn-success {
            background-color: #10B981;
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .word-box {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            background-color: #55BECC;
            color: #5B21B6;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-weight: 600;
            min-width: 80px;
            text-align: center;
            user-select: none;
        }
        .word-box:hover:not(.used):not(.disabled) {
            transform: scale(1.1) rotate(2deg);
            background-color: #E9D5FF;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .word-box.used {
            opacity: 0.4;
            background-color: #e9d5ff;
            cursor: not-allowed;
        }
        .word-box.disabled {
            opacity: 0.6;
            background-color: #e9d5ff;
            cursor: not-allowed;
        }
        
        #userSentenceContainer .word-box {
            background-color: #C4B5FD;
        }
        #userSentenceContainer .word-box:hover:not(.disabled) {
            transform: scale(1.05);
            background-color: #b19ff9;
        }

        .correct-answer-area {
            background-color: rgba(74, 222, 128, 0.1);
            border: 2px solid #22C55E;
            animation: pulseCorrect 1s ease-in-out;
        }
        .wrong-answer-area {
            background-color: rgba(239, 68, 68, 0.1);
            border: 2px solid #EF4444;
            animation: shakeHorizontal 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes pulseCorrect {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        @keyframes shakeHorizontal {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
            20%, 40%, 60%, 80% { transform: translateX(6px); }
        }
        
        .spinner {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-block;
            border-top: 3px solid #fff;
            border-right: 3px solid transparent;
            animation: spin 0.8s linear infinite;
        }
        #startLoading .spinner {
            border-top: 3px solid #026178;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #progressBar {
            background: linear-gradient(90deg, #026178, #A78BFA);
            transition: width 0.5s ease-in-out;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
        }

        #hint {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #3B82F6;
            padding: 0.75rem;
            margin-bottom: 1rem;
            line-height: 1.5;
            font-size: 0.9rem;
            color: #1E3A8A;
        }

        #hintTrigger {
            font-size: 0.75rem;
            color: #93C5FD;
            cursor: pointer;
            transition: color 0.3s ease;
            text-align: left;
            margin-bottom: 0.5rem;
            display: inline-block;
        }
        #hintTrigger:hover {
            color: #3B82F6;
            text-decoration: underline;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div id="startScreen" class="screen card w-full max-w-md text-center">
        <h1 class="text-4xl font-bold text-blue-700 mb-6">Sentence Puzzle</h1>
        <p class="text-lg text-gray-700 mb-6">Ready to test your English? <br>Enter your name!</p>
        <input id="playerName" type="text" placeholder="Your Name" class="input-field w-full mb-6">
        <div class="relative">
            <button id="startButton" onclick="startGame()" class="btn btn-primary w-full">
                <span class="button-text">Let's Go!</span>
                <div id="startLoading" class="hidden absolute inset-0 flex items-center justify-center bg-blue-600 bg-opacity-50 rounded-lg">
                    <div class="spinner border-top-white"></div>
                </div>
            </button>
        </div>
        <h3 class="text-sm font-bold text-blue-700 mt-5">Fast English Ms.Yáº¿n</h3>
    </div>

    <div id="gameScreen" class="screen hidden card w-full max-w-3xl">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-3xl font-bold text-blue-700">Let's Finish Sentences!</h2>
            <p id="progress" class="text-lg text-gray-600 font-semibold"></p>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-5 mb-6 shadow-inner">
            <div id="progressBar" class="h-5 rounded-full" style="width: 0%"></div>
        </div>
        
        <div class="mb-4">
            <p id="hintTrigger" onclick="showHintText()">Click for a hint</p>
            <p id="hint" class="hidden"></p>
        </div>
        
        <span id="timeout" class="text-lg text-blue-700 font-semibold block text-right mb-4">Time: 0s</span>
        <div id="scrambledWords" class="flex flex-wrap gap-3 mb-6 p-4 bg-blue-50 rounded-lg min-h-[60px] justify-center">
        </div>
        <div id="userSentenceContainer" class="border-2 border-dashed border-blue-300 rounded-lg p-4 min-h-[70px] mb-6 flex flex-wrap gap-3 items-center justify-center">
            <span class="placeholder-text text-gray-400 italic">Click words to add</span>
        </div>
        
        <div class="flex justify-center items-center gap-4">
            <button id="checkButton" onclick="checkSentence()" class="btn btn-primary">Check Sentence</button>
            <div class="relative">
                <button id="nextButton" onclick="nextQuestion()" class="btn btn-success hidden">
                    <span class="button-text">Next Question</span>
                    <div id="nextLoading" class="hidden absolute inset-0 flex items-center justify-center bg-green-600 bg-opacity-50 rounded-lg">
                        <div class="spinner border-top-white"></div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <div id="endScreen" class="screen hidden card w-full max-w-md text-center">
        <h2 class="text-4xl font-bold text-blue-700 mb-4">Awesome!</h2>
        <img src="https://img.icons8.com/color/100/000000/trophy.png" alt="Trophy" class="mx-auto mb-4"/>
        <p id="playerNameDisplay" class="text-2xl text-gray-800 font-semibold mb-2"></p>
        <p id="completionTime" class="text-xl text-gray-700 mb-6"></p>
        <p class="text-lg text-gray-600 mb-8">You've mastered all the puzzles!</p>
        <button onclick="restartGame()" class="btn btn-primary w-full">Play Again</button>
    </div>

    <script>
        let questions = [];
        let currentQuestion = 0;
        let userSentenceData = [];
        let startTime;
        let gameTimerInterval;
        let playerName = '';
        let hintUsedForCurrentQuestion = false;
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxOdtOPzggtZVBIiWLG1-m3Q4RpbzNxWuJrGn5o4l5_VZPMkt9b0TLfCDsOOEucHLyRDQ/exec';

        const startScreen = document.getElementById('startScreen');
        const gameScreen = document.getElementById('gameScreen');
        const endScreen = document.getElementById('endScreen');
        const playerNameInput = document.getElementById('playerName');
        const startButton = document.getElementById('startButton');
        const startLoading = document.getElementById('startLoading');
        const nextButton = document.getElementById('nextButton');
        const nextLoading = document.getElementById('nextLoading');
        const checkButton = document.getElementById('checkButton');
        const scrambledWordsContainer = document.getElementById('scrambledWords');
        const userSentenceContainer = document.getElementById('userSentenceContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progress');
        const hintElement = document.getElementById('hint');
        const hintTrigger = document.getElementById('hintTrigger');
        const timerDisplay = document.getElementById('timeout');
        const placeholderText = userSentenceContainer.querySelector('.placeholder-text');

        function switchScreen(current, next) {
            current.classList.add('hidden');
            setTimeout(() => {
                next.classList.remove('hidden');
                next.style.position = 'relative';
                current.style.position = 'absolute';
            }, 50);
        }

        function showButtonLoading(button, loadingIndicator, show, buttonTextContent = null) {
            const textSpan = button.querySelector('.button-text');
            if (show) {
                if (textSpan) textSpan.style.opacity = '0';
                else button.style.color = 'transparent';
                loadingIndicator.classList.remove('hidden');
                button.disabled = true;
            } else {
                if (textSpan) textSpan.style.opacity = '1';
                else button.style.color = '';
                loadingIndicator.classList.add('hidden');
                button.disabled = false;
            }
        }

        async function fetchQuestions() {
            showButtonLoading(startButton, startLoading, true);
            try {
                const response = await fetch(WEB_APP_URL);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('No questions received or data is not an array.');
                }
                questions = data.map(q => {
                    if (!q.sentence || typeof q.sentence !== 'string' || !q.hint) {
                        console.warn('Invalid question format, skipping:', q);
                        return null;
                    }
                    const cleanSentence = q.sentence.replace(/[.,!?]$/, '');
                    return {
                        ...q,
                        words: cleanSentence.split(' ').sort(() => Math.random() - 0.5),
                        originalSentence: q.sentence
                    };
                }).filter(q => q !== null);

                if (questions.length === 0) {
                    throw new Error('All questions were in an invalid format.');
                }
            } catch (error) {
                console.error('Error fetching questions:', error);
                alert(`Failed to load questions: ${error.message}. Please check the connection or contact the administrator.`);
                throw error;
            }
        }

        async function startGame() {
            playerName = playerNameInput.value.trim();
            if (!playerName) {
                alert('Please enter your name!');
                playerNameInput.focus();
                return;
            }
            
            try {
                await fetchQuestions();
                switchScreen(startScreen, gameScreen);
                startTime = new Date();
                startTimer();
                currentQuestion = 0;
                loadQuestion();
            } catch (error) {
                showButtonLoading(startButton, startLoading, false);
                return;
            }
            showButtonLoading(startButton, startLoading, false);
        }

        function startTimer() {
            clearInterval(gameTimerInterval);
            let seconds = 0;
            timerDisplay.textContent = `Time: ${seconds}s`;
            gameTimerInterval = setInterval(() => {
                seconds++;
                timerDisplay.textContent = `Time: ${seconds}s`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(gameTimerInterval);
        }

        function showHintText() {
            if (hintUsedForCurrentQuestion || questions.length === 0 || !questions[currentQuestion]) return;
            hintTrigger.classList.add('hidden');
            hintElement.classList.remove('hidden');
            hintElement.textContent = `Hint: ${questions[currentQuestion].hint}`;
            hintUsedForCurrentQuestion = true;
        }

        function loadQuestion() {
            if (currentQuestion >= questions.length) return;

            const q = questions[currentQuestion];
            progressText.textContent = `Question ${currentQuestion + 1} of ${questions.length}`;
            progressBar.style.width = `${((currentQuestion + 1) / questions.length) * 100}%`;
            
            hintUsedForCurrentQuestion = false;
            hintTrigger.classList.remove('hidden');
            hintElement.classList.add('hidden');
            hintElement.textContent = '';

            scrambledWordsContainer.innerHTML = '';
            userSentenceContainer.innerHTML = '';
            if (placeholderText) placeholderText.classList.remove('hidden');
            userSentenceData = [];

            q.words.forEach((word, index) => {
                const wordId = `scrambled-${currentQuestion}-${index}`;
                const div = document.createElement('div');
                div.textContent = word;
                div.className = 'word-box';
                div.id = wordId;
                div.dataset.word = word;
                div.dataset.originalIndex = index;
                div.onclick = () => handleWordClick(wordId, word, true);
                scrambledWordsContainer.appendChild(div);
            });

            checkButton.classList.remove('hidden');
            nextButton.classList.add('hidden');
            userSentenceContainer.className = 'border-2 border-dashed border-blue-300 rounded-lg p-4 min-h-[70px] mb-6 flex flex-wrap gap-3 items-center justify-center';
            showButtonLoading(nextButton, nextLoading, false);
        }

        function handleWordClick(originalWordId, wordText, isScrambled) {
            const originalWordElement = document.getElementById(originalWordId);
            if (isScrambled) {
                if (!originalWordElement || originalWordElement.classList.contains('used') || originalWordElement.classList.contains('disabled')) {
                    return;
                }
                originalWordElement.classList.add('used');
                const userWordId = `user-${originalWordId}-${Date.now()}`;
                const userWordDiv = document.createElement('div');
                userWordDiv.textContent = wordText;
                userWordDiv.className = 'word-box';
                userWordDiv.id = userWordId;
                userWordDiv.dataset.originalId = originalWordId;
                userWordDiv.dataset.word = wordText;
                userWordDiv.onclick = () => handleWordClick(userWordId, wordText, false);
                
                userSentenceContainer.appendChild(userWordDiv);
                userSentenceData.push({ originalId: originalWordId, text: wordText, userWordId: userWordId });

                if (placeholderText && !placeholderText.classList.contains('hidden')) {
                    placeholderText.classList.add('hidden');
                }
            } else {
                const userWordElement = document.getElementById(originalWordId);
                if (userWordElement) {
                    userWordElement.remove();
                }
                const originalWordElement = document.getElementById(userSentenceData.find(data => data.userWordId === originalWordId).originalId);
                if (originalWordElement) {
                    originalWordElement.classList.remove('used');
                }
                userSentenceData = userSentenceData.filter(data => data.userWordId !== originalWordId);
                if (userSentenceData.length === 0 && placeholderText) {
                    placeholderText.classList.remove('hidden');
                }
            }
        }

        function checkSentence() {
            const q = questions[currentQuestion];
            const constructedSentence = userSentenceData.map(data => data.text).join(' ');
            const isCorrect = constructedSentence.toLowerCase().trim() === q.originalSentence.replace(/[.,!?]$/, '').toLowerCase().trim();

            userSentenceContainer.className = `border-2 rounded-lg p-4 min-h-[70px] mb-6 flex flex-wrap gap-3 items-center justify-center ${isCorrect ? 'correct-answer-area' : 'wrong-answer-area'}`;
            
            if (isCorrect) {
                fireConfetti();
                checkButton.classList.add('hidden');
                nextButton.classList.remove('hidden');
                Array.from(scrambledWordsContainer.children).forEach(child => {
                    child.classList.add('disabled');
                    child.onclick = null;
                });
                Array.from(userSentenceContainer.children).forEach(child => {
                    if (child.classList.contains('word-box')) {
                        child.classList.add('disabled');
                        child.onclick = null;
                    }
                });
            }
        }

        function fireConfetti() {
            var end = Date.now() + (3 * 1000);
            var colors = ['#026178', '#EC4899', '#F59E0B', '#10B981'];

            function frame() {
                confetti({
                    particleCount: 4,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: colors
                });
                confetti({
                    particleCount: 4,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: colors
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }
            frame();
        }

        async function nextQuestion() {
            currentQuestion++;
            if (currentQuestion < questions.length) {
                showButtonLoading(nextButton, nextLoading, true);
                setTimeout(() => {
                    loadQuestion();
                    showButtonLoading(nextButton, nextLoading, false);
                }, 300);
            } else {
                stopTimer();
                const timeTaken = Math.round((new Date() - startTime) / 1000);
                showButtonLoading(nextButton, nextLoading, true, "Finishing...");
                
                try {
                    await fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ name: playerName, time: timeTaken })
                    });
                    console.log('Results submitted (no-cors mode).');
                } catch (error) {
                    console.error('Error posting results:', error.message);
                    alert(`Failed to save your results due to a network error. Your time was ${timeTaken} seconds.`);
                } finally {
                    showButtonLoading(nextButton, nextLoading, false);
                    endGame(timeTaken);
                }
            }
        }

        function endGame(timeTaken) {
            document.getElementById('playerNameDisplay').textContent = `Well done, ${playerName}!`;
            document.getElementById('completionTime').textContent = `You finished in ${timeTaken} seconds!`;
            switchScreen(gameScreen, endScreen);
            fireConfetti();
        }

        function restartGame() {
            switchScreen(endScreen, startScreen);
            currentQuestion = 0;
            playerNameInput.value = '';
            progressBar.style.width = '0%';
            progressText.textContent = '';
            timerDisplay.textContent = 'Time: 0s';
            if (placeholderText) placeholderText.classList.remove('hidden');
            hintUsedForCurrentQuestion = false;
            hintTrigger.classList.remove('hidden');
            hintElement.classList.add('hidden');
            hintElement.textContent = '';
        }
    </script>
</body>
</html>
